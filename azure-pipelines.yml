trigger:
  branches:
    include:
      - '*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: build.variables
  - name: APP_NAME
    value: $(projectName)
  - name: RUNTIME_VERSION
    value: '4.9.0'
  - name: CLOUDHUB_REGION
    value: 'us-east-1'
  - name: WORKER_SIZE
    value: 'MICRO'
  - name: WORKER_VCORES
    value: '0.1'
  - name: WORKERS
    value: '1'

stages:
  #####################################################
  # BUILD STAGE
  #####################################################
  - stage: Build
    displayName: 'Build Application'
    jobs:
      - job: BuildJob
        displayName: 'Maven Build'
        steps:
          - task: DownloadSecureFile@1
            name: mavenSettings
            displayName: 'Download Maven Settings'
            inputs:
              secureFile: 'settings.xml'
          
          - script: |
              mkdir -p ~/.m2
              cp $(mavenSettings.secureFilePath) ~/.m2/settings.xml
            displayName: 'Install Maven Settings'
          
          - task: JavaToolInstaller@0
            displayName: 'Setup Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          
          - script: |
              echo "Building Mule Application..."
              mvn clean package -DskipTests -s ~/.m2/settings.xml
              ls -lh target/*.jar
            displayName: 'Maven Package'
          
          - task: CopyFiles@2
            displayName: 'Copy Artifacts'
            inputs:
              Contents: '**/target/*.jar'
              TargetFolder: $(Build.ArtifactStagingDirectory)
              CleanTargetFolder: true
              flattenFolders: true
          
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Artifacts'
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)
              artifact: 'mule-app'

  #####################################################
  # DEPLOY STAGE - Direct CloudHub REST API
  #####################################################
  - stage: Deploy
    displayName: 'Deploy to CloudHub'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: DeployJob
        displayName: 'CloudHub REST API Deployment'
        steps:
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Build Artifacts'
            inputs:
              artifactName: 'mule-app'
              targetPath: $(System.DefaultWorkingDirectory)/artifacts
          
          - script: |
              echo "=========================================="
              echo " CloudHub Deployment via REST API"
              echo "=========================================="
              echo "Application: $(APP_NAME)"
              echo "Runtime: $(RUNTIME_VERSION)"
              echo "Region: $(CLOUDHUB_REGION)"
              echo "Organization: $(muleOrgId)"
              echo "Environment: $(environmentId)"
              echo ""
              
              # Find JAR file
              JAR_FILE=$(find $(System.DefaultWorkingDirectory)/artifacts -name "*.jar" -type f | head -1)
              
              if [ -z "$JAR_FILE" ]; then
                echo "‚ùå JAR file not found!"
                exit 1
              fi
              
              echo "üì¶ JAR: $(basename "$JAR_FILE")"
              echo "üì¶ Size: $(du -h "$JAR_FILE" | cut -f1)"
              echo ""
              
              # Step 1: Get Access Token
              echo "üîê Getting access token..."
              TOKEN_RESPONSE=$(curl -s -X POST "https://anypoint.mulesoft.com/accounts/api/v2/oauth2/token" \
                -H "Content-Type: application/json" \
                -d "{
                  \"grant_type\": \"client_credentials\",
                  \"client_id\": \"$(anypointClientId)\",
                  \"client_secret\": \"$(anypointClientSecret)\"
                }")
              
              ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)
              
              if [ -z "$ACCESS_TOKEN" ]; then
                echo "‚ùå Failed to get access token"
                echo "$TOKEN_RESPONSE"
                exit 1
              fi
              
              echo "‚úÖ Access token obtained"
              echo ""
              
              # Step 2: Check if app exists
              echo "üîç Checking if application exists..."
              APP_EXISTS=$(curl -s -X GET \
                "https://anypoint.mulesoft.com/cloudhub/api/v2/applications/$(APP_NAME)" \
                -H "Authorization: Bearer $ACCESS_TOKEN" \
                -H "X-ANYPNT-ORG-ID: $(muleOrgId)" \
                -H "X-ANYPNT-ENV-ID: $(environmentId)" \
                -w "%{http_code}" -o /dev/null)
              
              if [ "$APP_EXISTS" = "200" ]; then
                echo "‚ö†Ô∏è  Application exists - will update"
                DEPLOY_METHOD="PUT"
                DEPLOY_ENDPOINT="https://anypoint.mulesoft.com/cloudhub/api/v2/applications/$(APP_NAME)"
              else
                echo "üìù New application - will create"
                DEPLOY_METHOD="POST"
                DEPLOY_ENDPOINT="https://anypoint.mulesoft.com/cloudhub/api/v2/applications"
              fi
              
              echo ""
              
              # Step 3: Prepare application configuration JSON
              cat > /tmp/appInfoJson.json <<APPJSON
              {
                "domain": "$(APP_NAME)",
                "muleVersion": {"version": "$(RUNTIME_VERSION)"},
                "region": "$(CLOUDHUB_REGION)",
                "monitoringEnabled": true,
                "monitoringAutoRestart": true,
                "workers": {
                  "amount": $(WORKERS),
                  "type": {
                    "name": "$(WORKER_SIZE)",
                    "weight": "$(WORKER_VCORES)",
                    "cpu": "$(WORKER_VCORES) vCores",
                    "memory": "500 MB"
                  }
                },
                "properties": {
                  "mule.env": "dev",
                  "secure.key": "mule"
                },
                "loggingNgEnabled": true,
                "persistentQueues": false,
                "objectStoreV2": true
              }
              APPJSON
              
              echo "üìÑ Application config:"
              cat /tmp/appInfoJson.json
              echo ""
              
              # Step 4: Deploy application
              echo "üöÄ Deploying to CloudHub..."
              DEPLOY_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X $DEPLOY_METHOD \
                "$DEPLOY_ENDPOINT" \
                -H "Authorization: Bearer $ACCESS_TOKEN" \
                -H "X-ANYPNT-ORG-ID: $(muleOrgId)" \
                -H "X-ANYPNT-ENV-ID: $(environmentId)" \
                -F "file=@$JAR_FILE" \
                -F "autoStart=true" \
                -F "appInfoJson=<>/tmp/appInfoJson.json;type=application/json")
              
              HTTP_CODE=$(echo "$DEPLOY_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
              RESPONSE_BODY=$(echo "$DEPLOY_RESPONSE" | grep -v "HTTP_CODE:")
              
              echo ""
              echo "Response Code: $HTTP_CODE"
              
              if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
                echo ""
                echo "=========================================="
                echo " ‚úÖ DEPLOYMENT SUCCESSFUL!"
                echo "=========================================="
                echo ""
                echo "Application: $(APP_NAME)"
                echo "Region: $(CLOUDHUB_REGION)"
                echo "Status: Deploying..."
                echo ""
                echo "üåê Application URL:"
                echo "   https://$(APP_NAME).$(CLOUDHUB_REGION).cloudhub.io"
                echo ""
                echo "üåê CloudHub Console:"
                echo "   https://anypoint.mulesoft.com/cloudhub"
                echo ""
                
                # Wait and check status
                echo "‚è≥ Waiting for deployment to start..."
                sleep 15
                
                STATUS_RESPONSE=$(curl -s -X GET \
                  "https://anypoint.mulesoft.com/cloudhub/api/v2/applications/$(APP_NAME)" \
                  -H "Authorization: Bearer $ACCESS_TOKEN" \
                  -H "X-ANYPNT-ORG-ID: $(muleOrgId)" \
                  -H "X-ANYPNT-ENV-ID: $(environmentId)")
                
                APP_STATUS=$(echo "$STATUS_RESPONSE" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
                echo "Current Status: $APP_STATUS"
                
              else
                echo ""
                echo "=========================================="
                echo " ‚ùå DEPLOYMENT FAILED"
                echo "=========================================="
                echo ""
                echo "Response:"
                echo "$RESPONSE_BODY"
                echo ""
                exit 1
              fi
              
            displayName: 'Deploy via REST API'
            env:
              anypointClientId: $(anypointClientId)
              anypointClientSecret: $(anypointClientSecret)
              muleOrgId: $(muleOrgId)
              environmentId: $(environmentId)
