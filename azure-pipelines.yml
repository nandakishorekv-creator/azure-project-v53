trigger:
  branches:
    include:
      - '*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: build.variables
  - name: APP_NAME
    value: $(projectName)
  - name: RUNTIME_VERSION
    value: '4.9.0'
  - name: CH2_TARGET
    value: 'njcAssetPvtSpace'  # ‚ö†Ô∏è REPLACE with your Private Space name
  - name: CH2_ENVIRONMENT
    value: 'dev'
  - name: CH2_REPLICAS
    value: '1'
  - name: CH2_VCORES
    value: '0.1'

stages:
  #####################################################
  # BUILD STAGE
  #####################################################
  - stage: Build
    displayName: 'Build Mule Application'
    jobs:
      - job: BuildJob
        displayName: 'Maven Build'
        steps:
          - task: DownloadSecureFile@1
            name: mavenSettings
            displayName: 'Download Maven Settings'
            inputs:
              secureFile: 'settings.xml'
          
          - script: |
              mkdir -p ~/.m2
              cp $(mavenSettings.secureFilePath) ~/.m2/settings.xml
            displayName: 'Install Maven Settings'
          
          - task: JavaToolInstaller@0
            displayName: 'Setup Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          
          - script: |
              echo "=========================================="
              echo " Building Mule Application"
              echo "=========================================="
              echo "Project: $(APP_NAME)"
              echo "Runtime: $(RUNTIME_VERSION)"
              echo ""
              
              mvn clean package \
                -DskipTests \
                -Dsecure.key=mule \
                -Dmule.env=dev \
                -s ~/.m2/settings.xml
              
              if [ $? -eq 0 ]; then
                echo ""
                echo "‚úÖ BUILD SUCCESSFUL"
                echo ""
                ls -lh target/*.jar
              else
                echo "‚ùå BUILD FAILED"
                exit 1
              fi
            displayName: 'Maven Package'
          
          # Publish entire project (JAR + POM)
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Build Artifacts'
            inputs:
              targetPath: $(System.DefaultWorkingDirectory)
              artifact: 'mule-project'
              publishLocation: 'pipeline'

  #####################################################
  # PUBLISH TO EXCHANGE STAGE
  #####################################################
  - stage: PublishExchange
    displayName: 'Publish to Anypoint Exchange'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: PublishJob
        displayName: 'Exchange Publication'
        steps:
          - task: DownloadSecureFile@1
            name: mavenSettings
            inputs:
              secureFile: 'settings.xml'
          
          - script: |
              mkdir -p ~/.m2
              cp $(mavenSettings.secureFilePath) ~/.m2/settings.xml
            displayName: 'Install Maven Settings'
          
          - task: JavaToolInstaller@0
            displayName: 'Setup Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Build Artifacts'
            inputs:
              artifactName: 'mule-project'
              targetPath: $(System.DefaultWorkingDirectory)
          
          # Publish JAR to Exchange using deploy-file
          - script: |
              echo "=========================================="
              echo " Publishing to Anypoint Exchange"
              echo "=========================================="
              
              # Find the built JAR
              JAR_FILE=$(find target -name "*-mule-application.jar" -type f | head -1)
              
              if [ -z "$JAR_FILE" ]; then
                echo "‚ùå Mule application JAR not found!"
                echo "Files in target:"
                ls -la target/
                exit 1
              fi
              
              echo "üì¶ JAR File: $JAR_FILE"
              echo "üì¶ File Size: $(du -h "$JAR_FILE" | cut -f1)"
              echo ""
              
              # Extract coordinates from POM
              GROUP_ID=$(grep -m1 '<groupId>' pom.xml | sed 's/.*<groupId>\(.*\)<\/groupId>.*/\1/' | tr -d '[:space:]')
              ARTIFACT_ID=$(grep -m1 '<artifactId>' pom.xml | sed 's/.*<artifactId>\(.*\)<\/artifactId>.*/\1/' | tr -d '[:space:]')
              VERSION=$(grep -m1 '<version>' pom.xml | sed 's/.*<version>\(.*\)<\/version>.*/\1/' | tr -d '[:space:]')
              
              echo "Exchange Coordinates:"
              echo "  Group ID: $GROUP_ID"
              echo "  Artifact ID: $ARTIFACT_ID"
              echo "  Version: $VERSION"
              echo ""
              
              if [ -z "$GROUP_ID" ] || [ -z "$ARTIFACT_ID" ] || [ -z "$VERSION" ]; then
                echo "‚ùå Failed to extract coordinates from POM"
                exit 1
              fi
              
              # Set Exchange credentials
              export ANYPOINT_CLIENT_ID="$(anypointClientId)"
              export ANYPOINT_CLIENT_SECRET="$(anypointClientSecret)"
              
              echo "üöÄ Publishing to Exchange..."
              echo ""
              
              # Deploy JAR file directly to Exchange
              mvn deploy:deploy-file \
                -DgroupId="$GROUP_ID" \
                -DartifactId="$ARTIFACT_ID" \
                -Dversion="$VERSION" \
                -Dpackaging=jar \
                -Dclassifier=mule-application \
                -Dfile="$JAR_FILE" \
                -DrepositoryId=anypoint-exchange-v3 \
                -Durl=https://maven.anypoint.mulesoft.com/api/v3/organizations/$GROUP_ID/maven \
                -DgeneratePom=false \
                -DpomFile=pom.xml \
                -s ~/.m2/settings.xml
              
              if [ $? -eq 0 ]; then
                echo ""
                echo "=========================================="
                echo " ‚úÖ PUBLISHED TO EXCHANGE"
                echo "=========================================="
                echo ""
                echo "Asset: $GROUP_ID:$ARTIFACT_ID:$VERSION:mule-application"
                echo ""
                echo "üåê View in Exchange:"
                echo "   https://anypoint.mulesoft.com/exchange/assets/$GROUP_ID/$ARTIFACT_ID/"
                echo ""
              else
                echo ""
                echo "‚ùå EXCHANGE PUBLISH FAILED"
                exit 1
              fi
            displayName: 'Publish to Exchange'
            env:
              anypointClientId: $(anypointClientId)
              anypointClientSecret: $(anypointClientSecret)

  #####################################################
  # DEPLOY TO CLOUDHUB 2.0 STAGE
  #####################################################
  - stage: Deploy
    displayName: 'Deploy to CloudHub 2.0'
    dependsOn: PublishExchange
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: DeployJob
        displayName: 'CloudHub 2.0 Deployment'
        steps:
          - task: DownloadSecureFile@1
            name: mavenSettings
            inputs:
              secureFile: 'settings.xml'
          
          - script: |
              mkdir -p ~/.m2
              cp $(mavenSettings.secureFilePath) ~/.m2/settings.xml
            displayName: 'Install Maven Settings'
          
          - task: JavaToolInstaller@0
            displayName: 'Setup Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          
          - task: DownloadPipelineArtifact@2
            inputs:
              artifactName: 'mule-project'
              targetPath: $(System.DefaultWorkingDirectory)
          
          - script: |
              echo "=========================================="
              echo " CloudHub 2.0 Deployment"
              echo "=========================================="
              echo "Application: $(APP_NAME)"
              echo "Environment: $(CH2_ENVIRONMENT)"
              echo "Target: $(CH2_TARGET)"
              echo "Runtime: $(RUNTIME_VERSION)"
              echo "Replicas: $(CH2_REPLICAS)"
              echo "vCores: $(CH2_VCORES)"
              echo ""
              
              echo "üöÄ Deploying to CloudHub 2.0..."
              echo ""
              
              mvn mule:deploy \
                -Dmule.deployment.provider=MC \
                -Dconnectedapp.clientid=$(anypointClientId) \
                -Dconnectedapp.clientsecret=$(anypointClientSecret) \
                -Danypoint.orgid=$(muleOrgId) \
                -Dcloudhub2.applicationName=$(APP_NAME) \
                -Dcloudhub2.environment=$(CH2_ENVIRONMENT) \
                -Dcloudhub2.target=$(CH2_TARGET) \
                -Dcloudhub2.replicas=$(CH2_REPLICAS) \
                -Dcloudhub2.vcores=$(CH2_VCORES) \
                -s ~/.m2/settings.xml
              
              if [ $? -eq 0 ]; then
                echo ""
                echo "=========================================="
                echo " ‚úÖ DEPLOYMENT SUCCESSFUL!"
                echo "=========================================="
                echo ""
                echo "Application: $(APP_NAME)"
                echo "Environment: $(CH2_ENVIRONMENT)"
                echo "Target: $(CH2_TARGET)"
                echo ""
                echo "üåê Check Runtime Manager:"
                echo "   https://anypoint.mulesoft.com/cloudhub"
                echo ""
              else
                echo ""
                echo "=========================================="
                echo " ‚ùå DEPLOYMENT FAILED"
                echo "=========================================="
                echo ""
                echo "üí° Troubleshooting:"
                echo "1. Verify Private Space '$(CH2_TARGET)' exists"
                echo "2. Check environment '$(CH2_ENVIRONMENT)' is correct"
                echo "3. Ensure Exchange asset was published successfully"
                echo ""
                exit 1
              fi
            displayName: 'Deploy to CloudHub 2.0'
            env:
              anypointClientId: $(anypointClientId)
              anypointClientSecret: $(anypointClientSecret)
              muleOrgId: $(muleOrgId)
