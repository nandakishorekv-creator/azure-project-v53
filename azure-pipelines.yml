# Azure Pipelines YAML for MuleSoft Projects
trigger:
  branches:
    include:
      - '*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: build.variables
  - name: MAVEN_CACHE_FOLDER
    value: $(Pipeline.Workspace)/.m2/repository
  - name: APP_NAME
    value: $(projectName)
  - name: RUNTIME_VERSION
    value: '4.9.0'

stages:
  #####################################################
  # BUILD STAGE - SIMPLIFIED
  #####################################################
  - stage: Build
    displayName: 'Build Application'
    jobs:
      - job: BuildJob
        displayName: 'Maven Build'
        steps:
          - task: DownloadSecureFile@1
            name: mavenSettings
            displayName: 'Download Maven Settings'
            inputs:
              secureFile: 'settings.xml'
          
          - script: |
              echo "Installing Maven settings..."
              mkdir -p ~/.m2
              cp $(mavenSettings.secureFilePath) ~/.m2/settings.xml
              echo "Settings installed successfully"
            displayName: 'Install Maven Settings'
          
          - task: JavaToolInstaller@0
            displayName: 'Setup Java 11'
            inputs:
              versionSpec: '11'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          
          - task: Cache@2
            displayName: 'Cache Maven Dependencies'
            inputs:
              key: 'maven | "$(Agent.OS)" | pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
              path: $(MAVEN_CACHE_FOLDER)
          
          - script: |
              echo "Starting Maven build..."
              
              # First, try to compile with offline mode to check dependencies
              mvn clean compile \
                -DskipTests \
                -DskipMunitTests \
                -Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) \
                -s ~/.m2/settings.xml
              
              if [ $? -eq 0 ]; then
                echo "Compile successful, proceeding to package..."
                mvn clean package \
                  -DskipTests \
                  -DskipMunitTests \
                  -Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) \
                  -s ~/.m2/settings.xml
                
                if [ $? -eq 0 ]; then
                  echo "✅ BUILD SUCCESSFUL"
                  ls -lh target/*.jar
                else
                  echo "❌ PACKAGE FAILED"
                  exit 1
                fi
              else
                echo "❌ COMPILE FAILED"
                exit 1
              fi
            displayName: 'Maven Build & Package'
          
          - task: CopyFiles@2
            displayName: 'Copy Artifacts'
            inputs:
              Contents: '**/target/*.jar'
              TargetFolder: $(Build.ArtifactStagingDirectory)
              flattenFolders: true
          
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Artifacts'
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)
              artifact: mule-app
