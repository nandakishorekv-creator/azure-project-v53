trigger:
  branches:
    include:
      - '*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: build.variables
  - name: MAVEN_CACHE_FOLDER
    value: $(Pipeline.Workspace)/.m2/repository
  - name: APP_NAME
    value: $(projectName)
  - name: RUNTIME_VERSION
    value: '4.9.0'
  - name: CLOUDHUB_REGION
    value: 'us-east-2'
  - name: REPLICAS
    value: '1'
  - name: VCORES
    value: '0.1'

stages:
  #####################################################
  # BUILD STAGE
  #####################################################
  - stage: Build
    displayName: 'Build Application'
    jobs:
      - job: BuildJob
        displayName: 'Maven Build'
        steps:
          # Download settings.xml
          - task: DownloadSecureFile@1
            name: mavenSettings
            displayName: 'Download Maven Settings'
            inputs:
              secureFile: 'settings.xml'
          
          # Install settings.xml
          - script: |
              echo "üì¶ Installing Maven settings..."
              mkdir -p ~/.m2
              cp $(mavenSettings.secureFilePath) ~/.m2/settings.xml
              echo "‚úÖ Settings installed"
            displayName: 'Install Maven Settings'
          
          # Setup Java 17
          - task: JavaToolInstaller@0
            displayName: 'Setup Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          
          # Cache Maven dependencies
          # - task: Cache@2
          #   displayName: 'Cache Maven Dependencies'
          #   inputs:
          #     key: 'maven | "$(Agent.OS)" | **/pom.xml'
          #     restoreKeys: |
          #       maven | "$(Agent.OS)"
          #       maven
          #     path: $(MAVEN_CACHE_FOLDER)
          
          # Maven Build
          - script: |
              echo "=========================================="
              echo " Building Mule Application"
              echo "=========================================="
              mvn clean package \
                -DskipTests \
                -Dsecure.key=mule \
                -Dmule.env=dev \
                -s ~/.m2/settings.xml
              
              if [ $? -eq 0 ]; then
                echo ""
                echo "‚úÖ BUILD SUCCESSFUL"
                echo ""
                echo "Artifact Details:"
                ls -lh target/*.jar
              else
                echo "‚ùå BUILD FAILED"
                exit 1
              fi
            displayName: 'Maven Package'
          
          # Copy artifacts
          - task: CopyFiles@2
            displayName: 'Copy Artifacts'
            inputs:
              Contents: '**/target/*.jar'
              TargetFolder: $(Build.ArtifactStagingDirectory)
              CleanTargetFolder: true
              flattenFolders: true
          
          # Publish artifacts
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Artifacts'
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)
              artifact: 'mule-app'
              publishLocation: 'pipeline'

  #####################################################
  # DEPLOY STAGE - Using Credentials File
  #####################################################
  - stage: Deploy
    displayName: 'Deploy to CloudHub 1.0'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: DeployJob
        displayName: 'CloudHub 1.0 Deployment'
        steps:
          # Download artifacts
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Build Artifacts'
            inputs:
              artifactName: 'mule-app'
              targetPath: $(System.DefaultWorkingDirectory)/artifacts
          
          # Install Node.js
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '18.x'
          
          # Install Anypoint CLI
          - script: |
              echo "=========================================="
              echo " Installing Anypoint CLI"
              echo "=========================================="
              npm install -g anypoint-cli@latest
              
              if [ $? -eq 0 ]; then
                echo "‚úÖ Anypoint CLI installed successfully"
                
              else
                echo "‚ùå Failed to install Anypoint CLI"
                exit 1
              fi
            displayName: 'Install Anypoint CLI'
          
          # Create Anypoint Credentials File
          - script: |
              echo "=========================================="
              echo " Creating Anypoint Credentials"
              echo "=========================================="
              
              # Create .anypoint directory
              mkdir -p ~/.anypoint
              
              # Create credentials file with Connected App credentials
              cat > ~/.anypoint/credentials <<EOF
{
  "default": {
    "client_id": "$(anypointClientId)",
    "client_secret": "$(anypointClientSecret)",
    "organization": "$(muleOrgId)"
  }
}
EOF
              
              # Verify file was created
              if [ -f ~/.anypoint/credentials ]; then
                echo "‚úÖ Credentials file created successfully"
                echo "   Location: ~/.anypoint/credentials"
              else
                echo "‚ùå Failed to create credentials file"
                exit 1
              fi
              
            displayName: 'Setup Anypoint Credentials'
            env:
              anypointClientId: $(anypointClientId)
              anypointClientSecret: $(anypointClientSecret)
              muleOrgId: $(muleOrgId)
          
          # Deploy to CloudHub 1.0
          - script: |
              echo "=========================================="
              echo " CloudHub 1.0 Deployment"
              echo "=========================================="
              echo "Application: $(APP_NAME)"
              echo "Runtime: $(RUNTIME_VERSION)"
              echo "Region: $(CLOUDHUB_REGION)"
              echo "Organization: $(muleOrg)"
              echo "Organization ID: $(muleOrgId)"
              echo "Workers: $(REPLICAS)"
              echo "Worker Size: $(VCORES) vCores"
              echo ""
              
              # Find the JAR file
              JAR_FILE=$(find $(System.DefaultWorkingDirectory)/artifacts -name "*.jar" -type f | head -1)
              
              if [ -z "$JAR_FILE" ]; then
                echo "‚ùå ERROR: JAR file not found!"
                exit 1
              fi
              
              echo "üì¶ JAR File: $JAR_FILE"
              echo "üì¶ File Size: $(du -h "$JAR_FILE" | cut -f1)"
              echo ""
              
              # Test authentication
              echo "üîç Testing authentication..."
              anypoint-cli runtime-mgr cloudhub-application list --output json > /dev/null 2>&1
              
              if [ $? -eq 0 ]; then
                echo "‚úÖ Authentication verified - can access CloudHub"
              else
                echo "‚ö†Ô∏è  Warning: Could not list applications"
              fi
              
              echo ""
              echo "üöÄ Starting deployment to CloudHub 1.0..."
              echo ""
              
              # Deploy application (credentials from ~/.anypoint/credentials)
              anypoint-cli runtime-mgr cloudhub-application deploy \
                $(APP_NAME) \
                "$JAR_FILE" \
                --region $(CLOUDHUB_REGION) \
                --runtime $(RUNTIME_VERSION) \
                --workers $(REPLICAS) \
                --workerSize $(VCORES) \
                --property "mule.env:dev" \
                --property "secure.key:mule" \
                --output json
              
              DEPLOY_EXIT_CODE=$?
              
              echo ""
              if [ $DEPLOY_EXIT_CODE -eq 0 ]; then
                echo "=========================================="
                echo " ‚úÖ DEPLOYMENT SUCCESSFUL!"
                echo "=========================================="
                echo ""
                echo "Application: $(APP_NAME)"
                echo "Region: $(CLOUDHUB_REGION)"
                echo "Organization: $(muleOrg)"
                echo ""
                echo "üåê Application URL:"
                echo "   https://$(APP_NAME).$(CLOUDHUB_REGION).cloudhub.io"
                echo ""
                echo "üåê Check status at:"
                echo "   https://anypoint.mulesoft.com/cloudhub"
                echo ""
                
                # Display application status
                echo "üîç Checking application status..."
                sleep 15
                anypoint-cli runtime-mgr cloudhub-application describe $(APP_NAME) --output json 2>/dev/null | grep -o '"status":"[^"]*"' | cut -d'"' -f4 || echo "Status: Deploying..."
                
              else
                echo "=========================================="
                echo " ‚ùå DEPLOYMENT FAILED"
                echo "=========================================="
                echo ""
                echo "Exit Code: $DEPLOY_EXIT_CODE"
                echo ""
                echo "üí° Troubleshooting:"
                echo "1. Verify Connected App has Runtime Manager scopes"
                echo "2. Check if app name '$(APP_NAME)' is unique"
                echo "3. Verify organization ID: $(muleOrgId)"
                echo "4. Ensure region '$(CLOUDHUB_REGION)' is available"
                echo ""
                exit 1
              fi
              
            displayName: 'Deploy to CloudHub 1.0'
            env:
              anypointClientId: $(anypointClientId)
              anypointClientSecret: $(anypointClientSecret)
              muleOrg: $(muleOrg)
              muleOrgId: $(muleOrgId)
