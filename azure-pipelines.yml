trigger:
  branches:
    include:
      - '*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: build.variables
  - name: MAVEN_CACHE_FOLDER
    value: $(Pipeline.Workspace)/.m2/repository
  - name: APP_NAME
    value: 'azure-project-v53'
  - name: RUNTIME_VERSION
    value: '4.9.0'
  - name: CLOUDHUB_TARGET
    value: 'Cloudhub-US-East-2'
  - name: REPLICAS
    value: '1'
  - name: VCORES
    value: '0.1'

stages:
  #####################################################
  # BUILD STAGE
  #####################################################
  - stage: Build
    displayName: 'Build Application'
    jobs:
      - job: BuildJob
        displayName: 'Maven Build'
        steps:
          # Download settings.xml
          - task: DownloadSecureFile@1
            name: mavenSettings
            displayName: 'Download Maven Settings'
            inputs:
              secureFile: 'settings.xml'
          
          # Install settings.xml
          - script: |
              echo "üì¶ Installing Maven settings..."
              mkdir -p ~/.m2
              cp $(mavenSettings.secureFilePath) ~/.m2/settings.xml
              echo "‚úÖ Settings installed"
            displayName: 'Install Maven Settings'
          
          # Setup Java 17
          - task: JavaToolInstaller@0
            displayName: 'Setup Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          
          # Cache Maven dependencies
          - task: Cache@2
            displayName: 'Cache Maven Dependencies'
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
                maven
              path: $(MAVEN_CACHE_FOLDER)
          
          # Maven Build
          - script: |
              echo "=========================================="
              echo " Building Mule Application"
              echo "=========================================="
              mvn clean package \
                -DskipTests \
                -Dsecure.key=mule \
                -Dmule.env=dev \
                -s ~/.m2/settings.xml
              
              if [ $? -eq 0 ]; then
                echo ""
                echo "‚úÖ BUILD SUCCESSFUL"
                echo ""
                echo "Artifact Details:"
                ls -lh target/*.jar
              else
                echo "‚ùå BUILD FAILED"
                exit 1
              fi
            displayName: 'Maven Package'
          
          # Copy artifacts
          - task: CopyFiles@2
            displayName: 'Copy Artifacts'
            inputs:
              Contents: '**/target/*.jar'
              TargetFolder: $(Build.ArtifactStagingDirectory)
              CleanTargetFolder: true
              flattenFolders: true
          
          # Publish artifacts
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Artifacts'
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)
              artifact: 'mule-app'
              publishLocation: 'pipeline'

          ###################################################
          # DEPLOY STAGE: CloudHub 2.0 (Using Maven)
          #####################################################
          - stage: Deploy
            displayName: 'Deploy to CloudHub 2.0'
            dependsOn: Build
            condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
            jobs:
              - job: DeployToCloudHub
                displayName: 'Deploy to CloudHub Sandbox'
                steps:
                  # =============================================
                  # STEP 1: Checkout Code
                  # =============================================
                  - checkout: self
                    displayName: 'Checkout Source Code'
                    clean: true
                  
                  # =============================================
                  # STEP 2: Download settings.xml
                  # =============================================
                  - task: DownloadSecureFile@1
                    name: mavenSettingsDeploy
                    displayName: 'Download Maven Settings'
                    inputs:
                      secureFile: 'settings.xml'
                  
                  - script: |
                      echo "üì¶ Installing settings.xml..."
                      mkdir -p ~/.m2
                      cp $(mavenSettingsDeploy.secureFilePath) ~/.m2/settings.xml
                    displayName: 'Install Maven Settings'
                  
                  # =============================================
                  # STEP 3: Setup Java 17
                  # =============================================
                  - task: JavaToolInstaller@0
                    displayName: 'Install Java 17'
                    inputs:
                      versionSpec: '17'
                      jdkArchitectureOption: 'x64'
                      jdkSourceOption: 'PreInstalled'
                  
                  # =============================================
                  # STEP 4: Install Maven 3.9.10
                  # =============================================
                  - script: |
                      set -e
                      echo "üîß Installing Maven $(MAVEN_VERSION)..."
                      MAVEN_ARCHIVE="maven.tar.gz"
                      wget --progress=dot:giga -O "$MAVEN_ARCHIVE" "https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/$(MAVEN_VERSION)/apache-maven-$(MAVEN_VERSION)-bin.tar.gz"
                      tar -xzf "$MAVEN_ARCHIVE"
                      sudo rm -rf $(MAVEN_HOME) 2>/dev/null || true
                      sudo mv apache-maven-$(MAVEN_VERSION) $(MAVEN_HOME)
                      sudo chmod -R 755 $(MAVEN_HOME)
                      rm -f "$MAVEN_ARCHIVE"
                    displayName: 'Install Maven 3.9.10'
                  
                  # =============================================
                  # STEP 5: Cache Maven Dependencies
                  # =============================================
                  - task: Cache@2
                    displayName: 'Cache Maven Dependencies'
                    inputs:
                      key: 'maven | "$(Agent.OS)" | **/pom.xml'
                      restoreKeys: |
                        maven | "$(Agent.OS)"
                        maven
                      path: $(MAVEN_CACHE_FOLDER)
                  
                  # =============================================
                  # STEP 6: Deploy to CloudHub 2.0 (Maven)
                  # =============================================
                  - script: |
                      export M2_HOME=$(MAVEN_HOME)
                      export PATH=$(MAVEN_HOME)/bin:$PATH
                      
                      echo "=================================================="
                      echo " CloudHub 2.0 Deployment"
                      echo "=================================================="
                      echo "Application: $(APP_NAME)"
                      echo "Target: $(CLOUDHUB_TARGET)"
                      
                      # Verify POM
                      if [ ! -f pom.xml ]; then
                        echo "‚ùå ERROR: pom.xml not found"
                        exit 1
                      fi
        
                      # ‚úÖ Deploy using Maven
                      # This uses the <profile id="cloudhub2"> from your pom.xml
                      mvn clean deploy \
                        -Pcloudhub2 \
                        -Dmule.version=$(RUNTIME_VERSION) \
                        -DanypointClientId=$(anypointClientId) \
                        -DanypointClientSecret=$(anypointClientSecret) \
                        -Dmule.env=dev \
                        -Dsecure.key=mule \
                        -DskipTests \
                        -Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) \
                        -s ~/.m2/settings.xml \
                        -e
                      
                      if [ $? -eq 0 ]; then
                        echo "‚úÖ DEPLOYMENT SUCCESSFUL"
                      else
                        echo "‚ùå DEPLOYMENT FAILED"
                        exit 1
                      fi
                      
                    displayName: 'Deploy to CloudHub 2.0'
                    env:
                      M2_HOME: $(MAVEN_HOME)
                      anypointClientId: $(anypointClientId)
                      anypointClientSecret: $(anypointClientSecret)
