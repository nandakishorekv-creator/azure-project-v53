# Azure Pipelines YAML for MuleSoft Projects
# ‚úÖ FIXED: Anypoint CLI authentication with proper credential handling
# ‚úÖ Complete pipeline with Maven 3.9.10 + All features enabled

trigger:
  branches:
    include:
      - '*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: build.variables
  - name: disable.coverage.autogenerate
    value: 'true'
  - name: MAVEN_VERSION
    value: '3.9.10'
  - name: MAVEN_CACHE_FOLDER
    value: $(Pipeline.Workspace)/.m2/repository
  - name: MAVEN_HOME
    value: /opt/maven
  - name: PROJECT_NAME
    value: $[variables.projectName]
  - name: MULE_ORG
    value: $[variables.muleOrg]
  - name: MULE_ORG_ID
    value: $[variables.muleOrgId]

stages:
  #####################################################
  # BUILD STAGE
  #####################################################
  - stage: Build
    displayName: 'Build and Test Stage'
    jobs:
      - job: BuildAndTest
        displayName: 'Build and Test Job'
        steps:
          # =============================================
          # STEP 1: Download settings.xml (Secure Files)
          # =============================================
          - task: DownloadSecureFile@1
            name: mavenSettings
            displayName: 'Download Maven Settings from Secure Files'
            inputs:
              secureFile: 'settings.xml'
          
          # =============================================
          # STEP 2: Install Maven 3.9.10 (Multiple Mirrors + Retry Logic)
          # =============================================
          - script: |
              set -e
              
              echo "=================================================="
              echo "  Installing Maven $(MAVEN_VERSION)"
              echo "=================================================="
              echo ""
              
              # Show current state
              echo "üìã Pre-installed Maven:"
              mvn --version 2>/dev/null || echo "   Not found"
              echo ""
              
              MAVEN_DIR="apache-maven-$(MAVEN_VERSION)"
              MAVEN_ARCHIVE="maven.tar.gz"
              
              # ‚úÖ CRITICAL: Multiple mirror URLs with fallback
              # Try mirrors in order: dlcdn.apache.org ‚Üí archive.apache.org ‚Üí repo.maven.apache.org
              MAVEN_MIRRORS=(
                "https://dlcdn.apache.org/maven/maven-3/$(MAVEN_VERSION)/binaries/apache-maven-$(MAVEN_VERSION)-bin.tar.gz"
                "https://archive.apache.org/dist/maven/maven-3/$(MAVEN_VERSION)/binaries/apache-maven-$(MAVEN_VERSION)-bin.tar.gz"
                "https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/$(MAVEN_VERSION)/apache-maven-$(MAVEN_VERSION)-bin.tar.gz"
                "https://mirrors.ocf.berkeley.edu/apache/maven/maven-3/$(MAVEN_VERSION)/binaries/apache-maven-$(MAVEN_VERSION)-bin.tar.gz"
              )
              
              DOWNLOAD_SUCCESS=false
              
              # Try each mirror
              for MAVEN_URL in "${MAVEN_MIRRORS[@]}"; do
                echo "üì• Trying mirror: $(echo $MAVEN_URL | sed 's|/[^/]*$||' | sed 's|https://||')"
                echo "   Full URL: $MAVEN_URL"
                
                # Try wget first (with shorter timeout for faster failover)
                if timeout 90 wget --progress=dot:giga --timeout=30 --tries=2 -O "$MAVEN_ARCHIVE" "$MAVEN_URL" 2>&1; then
                  echo "‚úÖ Downloaded with wget from $(echo $MAVEN_URL | sed 's|https://||' | cut -d'/' -f1)"
                  DOWNLOAD_SUCCESS=true
                  break
                else
                  echo "‚ö†Ô∏è wget failed, trying curl..."
                  rm -f "$MAVEN_ARCHIVE" 2>/dev/null || true
                  
                  # Try curl as fallback
                  if timeout 90 curl -fL --progress-bar --connect-timeout 30 --max-time 90 --retry 2 -o "$MAVEN_ARCHIVE" "$MAVEN_URL" 2>&1; then
                    echo "‚úÖ Downloaded with curl from $(echo $MAVEN_URL | sed 's|https://||' | cut -d'/' -f1)"
                    DOWNLOAD_SUCCESS=true
                    break
                  else
                    echo "‚ùå Failed to download from this mirror"
                    rm -f "$MAVEN_ARCHIVE" 2>/dev/null || true
                  fi
                fi
                
                echo ""
              done
              
              if [ "$DOWNLOAD_SUCCESS" = false ]; then
                echo ""
                echo "‚ùå ERROR: All mirror downloads failed"
                echo "   Attempted mirrors:"
                for url in "${MAVEN_MIRRORS[@]}"; do
                  echo "   - $(echo $url | sed 's|https://||' | cut -d'/' -f1)"
                done
                echo ""
                echo "üí° Troubleshooting:"
                echo "   1. Check Azure DevOps agent network connectivity"
                echo "   2. Verify firewall rules allow HTTPS to Maven mirrors"
                echo "   3. Consider caching Maven in Azure Artifacts"
                exit 1
              fi
              
              # Verify download
              echo ""
              echo "üîç Verifying download..."
              FILE_SIZE=$(stat -c%s "$MAVEN_ARCHIVE" 2>/dev/null || stat -f%z "$MAVEN_ARCHIVE" 2>/dev/null)
              echo "   File size: $(echo $FILE_SIZE | numfmt --to=iec-i --suffix=B 2>/dev/null || echo ${FILE_SIZE} bytes)"
              
              if [ "$FILE_SIZE" -lt 8000000 ]; then
                echo "‚ùå ERROR: File too small ($FILE_SIZE bytes) - download may be corrupted"
                exit 1
              fi
              
              # Extract
              echo ""
              echo "üì¶ Extracting Maven..."
              tar -xzf "$MAVEN_ARCHIVE"
              
              if [ ! -d "$MAVEN_DIR" ]; then
                echo "‚ùå ERROR: Directory '$MAVEN_DIR' not found after extraction"
                echo "   Contents of current directory:"
                ls -la
                exit 1
              fi
              
              # Install
              echo ""
              echo "üì• Installing to $(MAVEN_HOME)..."
              sudo rm -rf $(MAVEN_HOME) 2>/dev/null || true
              sudo mv "$MAVEN_DIR" $(MAVEN_HOME)
              sudo chmod -R 755 $(MAVEN_HOME)
              
              # Verify installation
              if [ ! -f $(MAVEN_HOME)/bin/mvn ]; then
                echo "‚ùå ERROR: Maven binary not found at $(MAVEN_HOME)/bin/mvn"
                exit 1
              fi
              
              echo ""
              echo "‚úÖ Maven installed successfully:"
              $(MAVEN_HOME)/bin/mvn --version
              
              # Verify exact version
              ACTUAL_VERSION=$($(MAVEN_HOME)/bin/mvn --version | grep "Apache Maven" | awk '{print $3}')
              if [ "$ACTUAL_VERSION" = "$(MAVEN_VERSION)" ]; then
                echo "‚úÖ Version verified: $ACTUAL_VERSION"
              else
                echo "‚ö†Ô∏è WARNING: Version mismatch"
                echo "   Expected: $(MAVEN_VERSION)"
                echo "   Got: $ACTUAL_VERSION"
              fi
              
              # Cleanup
              rm -f "$MAVEN_ARCHIVE"
              
              echo ""
              echo "=================================================="
              echo "  ‚úÖ Maven $(MAVEN_VERSION) Installation Complete"
              echo "=================================================="
              
            displayName: 'Install Maven 3.9.10 (Multiple Mirrors)'
          
          # =============================================
          # STEP 3: Install settings.xml
          # =============================================
          - script: |
              echo "üì¶ Installing Maven settings.xml..."
              mkdir -p ~/.m2
              
              if [ ! -f "$(mavenSettings.secureFilePath)" ]; then
                echo "‚ùå ERROR: settings.xml not found"
                exit 1
              fi
              
              cp $(mavenSettings.secureFilePath) ~/.m2/settings.xml
              
              if [ -f ~/.m2/settings.xml ]; then
                echo "‚úÖ settings.xml installed"
                echo "   Location: ~/.m2/settings.xml"
                FILE_SIZE=$(stat -c%s ~/.m2/settings.xml 2>/dev/null || stat -f%z ~/.m2/settings.xml 2>/dev/null)
                echo "   Size: $FILE_SIZE bytes"
              else
                echo "‚ùå ERROR: Installation failed"
                exit 1
              fi
              
              echo ""
              echo "üìÑ Validating XML syntax..."
              
              # Check for common XML errors
              if grep -q "<n>" ~/.m2/settings.xml; then
                echo "‚ùå ERROR: Invalid XML tag '<n>' found in settings.xml"
                echo "   This should be '<name>'. Please regenerate settings.xml."
                exit 1
              fi
              
              # Validate XML structure
              if command -v xmllint >/dev/null 2>&1; then
                if xmllint --noout ~/.m2/settings.xml 2>&1; then
                  echo "‚úÖ XML syntax valid"
                else
                  echo "‚ùå ERROR: XML syntax errors detected"
                  exit 1
                fi
              fi
              
              echo ""
              echo "üìÑ Settings structure:"
              echo "   Servers configured:"
              grep -E '<id>' ~/.m2/settings.xml | grep -v '<?xml' | sed 's/^/     /' || echo "     None found"
              
            displayName: 'Install and Validate Maven Settings'

          # =============================================
          # STEP 4: Setup Java 17
          # =============================================
          - task: JavaToolInstaller@0
            displayName: 'Install Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          # =============================================
          # STEP 5: Verify Environment
          # =============================================
          - script: |
              echo "=================================================="
              echo "  Build Environment"
              echo "=================================================="
              echo ""
              
              echo "‚òï Java:"
              java -version 2>&1 | head -3
              echo "   JAVA_HOME: $JAVA_HOME"
              echo ""
              
              echo "üì¶ Maven:"
              export M2_HOME=$(MAVEN_HOME)
              export PATH=$(MAVEN_HOME)/bin:$PATH
              mvn --version
              echo "   M2_HOME: $M2_HOME"
              echo ""
              
              echo "‚öôÔ∏è Settings:"
              if [ -f ~/.m2/settings.xml ]; then
                echo "   ‚úÖ settings.xml exists"
              else
                echo "   ‚ùå settings.xml missing"
                exit 1
              fi
              echo ""
              
              echo "üìã POM:"
              if [ -f pom.xml ]; then
                echo "   ‚úÖ pom.xml found"
                grep -E "mule.maven.plugin.version|maven.compiler.source|app.runtime" pom.xml | head -5 || true
              else
                echo "   ‚ö†Ô∏è pom.xml not found"
              fi
              
              echo ""
              echo "‚úÖ Verification complete"
              
            displayName: 'Verify Build Environment'
            env:
              M2_HOME: $(MAVEN_HOME)

          # =============================================
          # STEP 6: Cache Maven Dependencies
          # =============================================
          - task: Cache@2
            displayName: 'Cache Maven Dependencies'
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
                maven
              path: $(MAVEN_CACHE_FOLDER)

          # =============================================
          # STEP 7: Install Anypoint CLI (SIMPLIFIED - NO CREDENTIALS)
          # =============================================
          - script: |
              echo "=================================================="
              echo "  Installing Anypoint CLI"
              echo "=================================================="
              echo ""
              
              # Install Anypoint CLI globally
              echo "üì¶ Installing Anypoint CLI..."
              npm install -g anypoint-cli@latest
              
              if [ $? -eq 0 ]; then
                echo ""
                echo "‚úÖ Anypoint CLI installed successfully"
                anypoint-cli --version
              else
                echo ""
                echo "‚ùå ERROR: Failed to install Anypoint CLI"
                exit 1
              fi
              
              echo ""
              echo "=================================================="
              echo "  ‚úÖ Installation Complete"
              echo "=================================================="
              echo ""
              echo "‚ÑπÔ∏è  Note: Credentials will be passed via command-line"
              echo "   parameters when running CLI commands"
              
            displayName: 'Install Anypoint CLI'

        #  # =============================================
        #   # STEP 8: API Governance Validation (FIXED)
        #   # =============================================
        #   - script: |
        #       echo "=================================================="
        #       echo "  API Governance Validation"
        #       echo "=================================================="
        #       echo ""
              
        #       # Check if Anypoint credentials are configured
        #       if [ ! -f ~/.anypoint/credentials.json ]; then
        #         echo "‚ö†Ô∏è Anypoint credentials not configured"
        #         echo "   Skipping governance validation..."
        #         exit 0
        #       fi
              
        #       echo "üîç Checking for governance ruleset..."
              
        #       # Check if ruleset.yaml exists
        #       if [ ! -f "ruleset.yaml" ]; then
        #         echo "‚ö†Ô∏è No ruleset.yaml found in project root"
        #         echo "   Skipping governance validation..."
        #         echo ""
        #         echo "   To enable governance:"
        #         echo "   1. Create ruleset.yaml in project root"
        #         echo "   2. Enable API Governance in Anypoint Platform"
        #         echo "   3. Grant 'Design Center Developer' scope to Connected App"
        #         exit 0
        #       fi
              
        #       echo "‚úÖ ruleset.yaml found"
        #       echo ""
              
        #       # Create project ZIP if needed
        #       if [ ! -f "$(PROJECT_NAME).zip" ]; then
        #         echo "üì¶ Creating project ZIP..."
        #         zip -r $(PROJECT_NAME).zip . -x "*.git*" -x "target/*" -x "*.zip"
        #         echo "‚úÖ ZIP created: $(PROJECT_NAME).zip"
        #       fi
              
        #       echo ""
        #       echo "üõ°Ô∏è Running governance validation..."
        #       echo "   Organization: $(MULE_ORG)"
        #       echo "   Ruleset: ruleset.yaml"
        #       echo ""
              
        #       # Run validation using default profile (credentials.json)
        #       anypoint-cli governance api validate \
        #         --rulesets ruleset.yaml \
        #         $(PROJECT_NAME).zip || {
        #           echo ""
        #           echo "‚ö†Ô∏è Governance validation failed"
        #           echo "   This is non-blocking - build will continue"
        #           echo ""
        #           echo "   Common issues:"
        #           echo "   - API Governance not enabled for organization"
        #           echo "   - Connected App missing required scopes"
        #           echo "   - Ruleset syntax errors"
        #           echo "   - API definition doesn't match ruleset"
        #         }
              
        #       echo ""
        #       echo "=================================================="
        #       echo "  Governance validation completed"
        #       echo "=================================================="
              
        #     displayName: 'API Governance Validation'
        #     continueOnError: true
        #     condition: and(succeeded(), ne(variables['MULE_ORG'], ''))

          # =============================================
          # STEP 9: Maven Validate (MUST SUCCEED)
          # =============================================
          - script: |
              export M2_HOME=$(MAVEN_HOME)
              export PATH=$(MAVEN_HOME)/bin:$PATH
              
              echo "üîç Running Maven validate..."
              echo ""
              
              mvn validate \
                -Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) \
                -s ~/.m2/settings.xml \
                -e
              
              if [ $? -ne 0 ]; then
                echo ""
                echo "‚ùå VALIDATION FAILED"
                echo ""
                echo "Common causes:"
                echo "1. settings.xml authentication issue"
                echo "2. Cannot download mule-maven-plugin"
                echo "3. Invalid POM.xml structure"
                exit 1
              fi
              
              echo ""
              echo "‚úÖ Validation completed successfully"
              
            displayName: 'Maven Validate'
            env:
              M2_HOME: $(MAVEN_HOME)

          # =============================================
          # STEP 10: Maven Package (MUST SUCCEED)
          # =============================================
          - script: |
              export M2_HOME=$(MAVEN_HOME)
              export PATH=$(MAVEN_HOME)/bin:$PATH
              
              echo "üì¶ Running Maven package..."
              echo ""
              
              mvn clean package \
                -Dmule.version=4.9.0 \
                -Dsecure.key=mule \
                -Dmule.env=dev \
                -DskipTests \
                -s ~/.m2/settings.xml \
                -e
              
              if [ $? -ne 0 ]; then
                echo ""
                echo "‚ùå PACKAGE BUILD FAILED"
                exit 1
              fi
              
              echo ""
              echo "‚úÖ Package completed successfully"
              echo ""
              
              # Verify JAR was created
              echo "üì¶ Verifying build artifacts..."
              if [ -d target ]; then
                JAR_FILE=$(ls -1 target/*.jar 2>/dev/null | head -1)
                if [ -n "$JAR_FILE" ]; then
                  echo "‚úÖ JAR file created:"
                  ls -lh target/*.jar
                else
                  echo "‚ùå ERROR: No JAR file found in target/"
                  echo "   Build may have failed silently"
                  exit 1
                fi
              else
                echo "‚ùå ERROR: target/ directory not found"
                echo "   Maven build did not execute properly"
                exit 1
              fi
              
            displayName: 'Maven Package'
            env:
              M2_HOME: $(MAVEN_HOME)

          # =============================================
          # STEP 11: Copy Build Artifacts
          # =============================================
          - task: CopyFiles@2
            displayName: 'Copy Build Artifacts'
            inputs:
              Contents: |
                **/target/*.jar
                pom.xml
              TargetFolder: $(Build.ArtifactStagingDirectory)
              flattenFolders: false

          # =============================================
          # STEP 12: Publish Pipeline Artifacts
          # =============================================
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Pipeline Artifacts'
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)
              artifact: 'drop'

  #####################################################
  # DEPLOY STAGE: CloudHub Deployment
  #####################################################
  - stage: Deploy
    displayName: 'Deploy to CloudHub'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: DeployToCloudHub
        displayName: 'Deploy to CloudHub Sandbox'
        steps:
          # =========================================
          # Re-install Maven for Deploy Stage
          # =========================================
          - script: |
              set -e
              
              echo "üîß Setting up Maven $(MAVEN_VERSION) for deployment..."
              
              MAVEN_MIRRORS=(
                "https://dlcdn.apache.org/maven/maven-3/$(MAVEN_VERSION)/binaries/apache-maven-$(MAVEN_VERSION)-bin.tar.gz"
                "https://archive.apache.org/dist/maven/maven-3/$(MAVEN_VERSION)/binaries/apache-maven-$(MAVEN_VERSION)-bin.tar.gz"
              )
              
              MAVEN_ARCHIVE="maven.tar.gz"
              DOWNLOAD_SUCCESS=false
              
              for MAVEN_URL in "${MAVEN_MIRRORS[@]}"; do
                if timeout 60 wget --timeout=20 --tries=2 -q -O "$MAVEN_ARCHIVE" "$MAVEN_URL" || \
                   timeout 60 curl -fL --connect-timeout 20 --max-time 60 -o "$MAVEN_ARCHIVE" "$MAVEN_URL"; then
                  DOWNLOAD_SUCCESS=true
                  break
                fi
                rm -f "$MAVEN_ARCHIVE" 2>/dev/null || true
              done
              
              if [ "$DOWNLOAD_SUCCESS" = false ]; then
                echo "‚ùå Download failed"
                exit 1
              fi
              
              # Extract and install
              tar -xzf "$MAVEN_ARCHIVE"
              sudo rm -rf $(MAVEN_HOME) 2>/dev/null || true
              sudo mv apache-maven-$(MAVEN_VERSION) $(MAVEN_HOME)
              sudo chmod -R 755 $(MAVEN_HOME)
              
              echo "‚úÖ Maven ready:"
              $(MAVEN_HOME)/bin/mvn --version
              
              rm -f "$MAVEN_ARCHIVE"
              
            displayName: 'Setup Maven for Deploy'
          
          # =========================================
          # Re-download settings.xml
          # =========================================
          - task: DownloadSecureFile@1
            name: mavenSettingsDeploy
            displayName: 'Download Maven Settings'
            inputs:
              secureFile: 'settings.xml'
          
          - script: |
              echo "üì¶ Installing settings.xml for deployment..."
              mkdir -p ~/.m2
              cp $(mavenSettingsDeploy.secureFilePath) ~/.m2/settings.xml
              
              if [ -f ~/.m2/settings.xml ]; then
                echo "‚úÖ settings.xml installed"
              else
                echo "‚ùå ERROR: settings.xml not found"
                exit 1
              fi
              
            displayName: 'Install Maven Settings for Deploy'

          # =========================================
          # Download Build Artifacts
          # =========================================
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Build Artifacts'
            inputs:
              artifact: 'drop'
              path: $(Pipeline.Workspace)/drop

          # =========================================
          # Deploy to CloudHub
          # =========================================
         - script: |
    export M2_HOME=$(MAVEN_HOME)
    export PATH=$(MAVEN_HOME)/bin:$PATH

    echo "=================================================="
    echo " CloudHub Deployment (Connected App)"
    echo "=================================================="

    echo "Using bearer token auth"
    echo "Runtime: 4.9.0"

    mvn clean deploy \
      -Pcloudhub \
      -Dmule.version=4.9.0 \
      -Danypoint.bearerToken=$(ANYPOINT_BEARER_TOKEN) \
      -DskipTests \
      -s ~/.m2/settings.xml \
      -e
  displayName: 'Deploy to CloudHub (Bearer Token)'
  env:
    ANYPOINT_BEARER_TOKEN: $(ANYPOINT_BEARER_TOKEN)