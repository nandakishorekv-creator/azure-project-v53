trigger:
  branches:
    include:
      - '*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: build.variables
  - name: MAVEN_CACHE_FOLDER
    value: $(Pipeline.Workspace)/.m2/repository
  - name: APP_NAME
    value: $(projectName)
  - name: RUNTIME_VERSION
    value: '4.9.0'
  # CloudHub 2.0 Configuration
  - name: CH2_TARGET
    value: 'azure-test'  # ‚ö†Ô∏è REPLACE with your Private Space name
  - name: CH2_ENVIRONMENT
    value: 'Sandbox'
  - name: CH2_REPLICAS
    value: '1'
  - name: CH2_VCORES
    value: '0.1'
  # Exchange coordinates
  - name: EXCHANGE_GROUP_ID
    value: $(muleOrgId)
  - name: EXCHANGE_ARTIFACT_ID
    value: $(projectName)
  - name: EXCHANGE_VERSION
    value: '1.0.0'

stages:
  #####################################################
  # BUILD STAGE
  #####################################################
  - stage: Build
    displayName: 'Build Mule Application'
    jobs:
      - job: BuildJob
        displayName: 'Maven Build'
        steps:
          # Download Maven settings.xml
          - task: DownloadSecureFile@1
            name: mavenSettings
            displayName: 'Download Maven Settings'
            inputs:
              secureFile: 'settings.xml'
          
          # Install Maven settings
          - script: |
              echo "üì¶ Installing Maven settings..."
              mkdir -p ~/.m2
              cp $(mavenSettings.secureFilePath) ~/.m2/settings.xml
              echo "‚úÖ Maven settings installed"
            displayName: 'Install Maven Settings'
          
          # Setup Java 17
          - task: JavaToolInstaller@0
            displayName: 'Setup Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          
          # Cache Maven dependencies
          # - task: Cache@2
          #   displayName: 'Cache Maven Dependencies'
          #   inputs:
          #     key: 'maven | "$(Agent.OS)" | **/pom.xml'
          #     restoreKeys: |
          #       maven | "$(Agent.OS)"
          #       maven
          #     path: $(MAVEN_CACHE_FOLDER)
          
          # Maven Build
          - script: |
              echo "=========================================="
              echo " Building Mule Application"
              echo "=========================================="
              echo "Project: $(APP_NAME)"
              echo "Runtime: $(RUNTIME_VERSION)"
              echo ""
              
              mvn clean package \
                -DskipTests \
                -Dsecure.key=mule \
                -Dmule.env=dev \
                -s ~/.m2/settings.xml
              
              if [ $? -eq 0 ]; then
                echo ""
                echo "‚úÖ BUILD SUCCESSFUL"
                echo ""
                ls -lh target/*.jar
              else
                echo "‚ùå BUILD FAILED"
                exit 1
              fi
            displayName: 'Maven Package'
          
          # Copy artifacts to staging
          - task: CopyFiles@2
            displayName: 'Copy Build Artifacts'
            inputs:
              Contents: |
                **/target/*.jar
                **/pom.xml
              TargetFolder: $(Build.ArtifactStagingDirectory)
              CleanTargetFolder: true
          
          # Publish artifacts
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Build Artifacts'
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)
              artifact: 'mule-app'
              publishLocation: 'pipeline'

  #####################################################
  # PUBLISH TO EXCHANGE STAGE
  #####################################################
  - stage: PublishExchange
    displayName: 'Publish to Anypoint Exchange'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: PublishJob
        displayName: 'Exchange Publication'
        steps:
          # Download Maven settings.xml
          - task: DownloadSecureFile@1
            name: mavenSettings
            displayName: 'Download Maven Settings'
            inputs:
              secureFile: 'settings.xml'
          
          # Install Maven settings
          - script: |
              mkdir -p ~/.m2
              cp $(mavenSettings.secureFilePath) ~/.m2/settings.xml
            displayName: 'Install Maven Settings'
          
          # Setup Java 17
          - task: JavaToolInstaller@0
            displayName: 'Setup Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          
          # Download build artifacts
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Build Artifacts'
            inputs:
              artifactName: 'mule-app'
              targetPath: $(System.DefaultWorkingDirectory)
          
          # Publish to Exchange
          - script: |
              echo "=========================================="
              echo " Publishing to Anypoint Exchange"
              echo "=========================================="
              echo "Asset: $(EXCHANGE_GROUP_ID):$(EXCHANGE_ARTIFACT_ID):$(EXCHANGE_VERSION)"
              echo ""
              
              # Set Exchange credentials as environment variables
              export ANYPOINT_CLIENT_ID="$(anypointClientId)"
              export ANYPOINT_CLIENT_SECRET="$(anypointClientSecret)"
              
              mvn deploy \
                -DskipTests \
                -DskipMuleDeploy=true \
                -s ~/.m2/settings.xml
              
              if [ $? -eq 0 ]; then
                echo ""
                echo "=========================================="
                echo " ‚úÖ PUBLISHED TO EXCHANGE"
                echo "=========================================="
                echo ""
                echo "Asset: $(EXCHANGE_GROUP_ID):$(EXCHANGE_ARTIFACT_ID):$(EXCHANGE_VERSION)"
                echo ""
              else
                echo ""
                echo "‚ùå EXCHANGE PUBLISH FAILED"
                exit 1
              fi
            displayName: 'Publish to Exchange'
            env:
              anypointClientId: $(anypointClientId)
              anypointClientSecret: $(anypointClientSecret)

  #####################################################
  # DEPLOY TO CLOUDHUB 2.0 STAGE
  #####################################################
  - stage: Deploy
    displayName: 'Deploy to CloudHub 2.0'
    dependsOn: PublishExchange
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: DeployJob
        displayName: 'CloudHub 2.0 Deployment'
        steps:
          - script: |
              echo "=========================================="
              echo " CloudHub 2.0 Deployment"
              echo "=========================================="
              echo "Application: $(APP_NAME)"
              echo "Exchange Asset: $(EXCHANGE_GROUP_ID):$(EXCHANGE_ARTIFACT_ID):$(EXCHANGE_VERSION)"
              echo "Environment: $(CH2_ENVIRONMENT)"
              echo "Target: $(CH2_TARGET)"
              echo "Runtime: $(RUNTIME_VERSION)"
              echo ""
              
              # Get access token
              echo "üîê Authenticating..."
              TOKEN_RESPONSE=$(curl -s -X POST "https://anypoint.mulesoft.com/accounts/api/v2/oauth2/token" \
                -H "Content-Type: application/json" \
                -d "{\"grant_type\":\"client_credentials\",\"client_id\":\"$(anypointClientId)\",\"client_secret\":\"$(anypointClientSecret)\"}")
              
              ACCESS_TOKEN=$(echo $TOKEN_RESPONSE | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)
              
              if [ -z "$ACCESS_TOKEN" ]; then
                echo "‚ùå Failed to get access token"
                echo "Response: $TOKEN_RESPONSE"
                exit 1
              fi
              
              echo "‚úÖ Token obtained"
              echo ""
              
              # Get environment ID
              echo "üîç Getting environment ID for '$(CH2_ENVIRONMENT)'..."
              ENV_RESPONSE=$(curl -s -X GET \
                "https://anypoint.mulesoft.com/accounts/api/organizations/$(muleOrgId)/environments" \
                -H "Authorization: Bearer $ACCESS_TOKEN")
              
              ENV_ID=$(echo $ENV_RESPONSE | grep -o "\"name\":\"$(CH2_ENVIRONMENT)\"[^}]*\"id\":\"[^\"]*\"" | grep -o "\"id\":\"[^\"]*\"" | cut -d'"' -f4)
              
              if [ -z "$ENV_ID" ]; then
                echo "‚ùå Environment '$(CH2_ENVIRONMENT)' not found"
                echo "Available environments:"
                echo $ENV_RESPONSE | grep -o '"name":"[^"]*"' | cut -d'"' -f4
                exit 1
              fi
              
              echo "‚úÖ Environment ID: $ENV_ID"
              echo ""
              
              # Verify Exchange asset exists
              echo "üîç Verifying Exchange asset..."
              ASSET_CHECK=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X GET \
                "https://anypoint.mulesoft.com/exchange/api/v2/assets/$(EXCHANGE_GROUP_ID)/$(EXCHANGE_ARTIFACT_ID)/$(EXCHANGE_VERSION)" \
                -H "Authorization: Bearer $ACCESS_TOKEN
