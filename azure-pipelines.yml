trigger:
  branches:
    include:
      - '*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: build.variables
  - name: APP_NAME
    value: $(projectName)
  - name: RUNTIME_VERSION
    value: '4.9.0'
  # ‚ö†Ô∏è UPDATE THIS with your Private Space name from Runtime Manager
  - name: CH2_TARGET
    value: 'azure-test'
  - name: CH2_ENVIRONMENT
    value: 'Sandbox'
  - name: CH2_REPLICAS
    value: '1'
  - name: CH2_VCORES
    value: '0.1'
  # Exchange coordinates from your Exchange asset
  - name: EXCHANGE_GROUP_ID
    value: $(muleOrgId)
  - name: EXCHANGE_ARTIFACT_ID
    value: $(projectName)
  - name: EXCHANGE_VERSION
    value: '1.0.0'

stages:
  - stage: Deploy
    displayName: 'Deploy to CloudHub 2.0'
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
    jobs:
      - job: DeployJob
        displayName: 'Deploy from Exchange'
        steps:
          - script: |
              echo "=========================================="
              echo " CloudHub 2.0 Deployment from Exchange"
              echo "=========================================="
              echo "Application: $(APP_NAME)"
              echo "Exchange: $(EXCHANGE_GROUP_ID):$(EXCHANGE_ARTIFACT_ID):$(EXCHANGE_VERSION)"
              echo "Environment: $(CH2_ENVIRONMENT)"
              echo "Target: $(CH2_TARGET)"
              echo ""
              
              # Get access token
              echo "üîê Authenticating..."
              TOKEN_RESPONSE=$(curl -s -X POST "https://anypoint.mulesoft.com/accounts/api/v2/oauth2/token" \
                -H "Content-Type: application/json" \
                -d "{\"grant_type\":\"client_credentials\",\"client_id\":\"$(anypointClientId)\",\"client_secret\":\"$(anypointClientSecret)\"}")
              
              ACCESS_TOKEN=$(echo $TOKEN_RESPONSE | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)
              
              if [ -z "$ACCESS_TOKEN" ]; then
                echo "‚ùå Failed to authenticate"
                exit 1
              fi
              echo "‚úÖ Authenticated"
              echo ""
              
              # Get environment ID
              echo "üîç Getting environment ID for '$(CH2_ENVIRONMENT)'..."
              ENV_RESPONSE=$(curl -s "https://anypoint.mulesoft.com/accounts/api/organizations/$(muleOrgId)/environments" \
                -H "Authorization: Bearer $ACCESS_TOKEN")
              
              ENV_ID=$(echo $ENV_RESPONSE | grep -o "\"name\":\"$(CH2_ENVIRONMENT)\"[^}]*\"id\":\"[^\"]*\"" | grep -o "\"id\":\"[^\"]*\"" | cut -d'"' -f4)
              
              if [ -z "$ENV_ID" ]; then
                echo "‚ùå Environment '$(CH2_ENVIRONMENT)' not found"
                exit 1
              fi
              echo "‚úÖ Environment ID: $ENV_ID"
              echo ""
              
              # Deploy
              echo "üöÄ Deploying to CloudHub 2.0..."
              
              DEPLOY_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
                "https://anypoint.mulesoft.com/amc/application-manager/api/v2/organizations/$(muleOrgId)/environments/$ENV_ID/deployments" \
                -H "Authorization: Bearer $ACCESS_TOKEN" \
                -H "X-ANYPNT-ENV-ID: $ENV_ID" \
                -H "X-ANYPNT-ORG-ID: $(muleOrgId)" \
                -H "Content-Type: application/json" \
                -d "{
                  \"name\": \"$(APP_NAME)\",
                  \"application\": {
                    \"ref\": {
                      \"groupId\": \"$(EXCHANGE_GROUP_ID)\",
                      \"artifactId\": \"$(EXCHANGE_ARTIFACT_ID)\",
                      \"version\": \"$(EXCHANGE_VERSION)\",
                      \"packaging\": \"jar\"
                    },
                    \"desiredState\": \"STARTED\",
                    \"configuration\": {
                      \"mule.agent.application.properties.service\": {
                        \"properties\": {
                          \"mule.env\": \"dev\",
                          \"secure.key\": \"mule\"
                        }
                      }
                    },
                    \"vCores\": \"$(CH2_VCORES)\",
                    \"integrations\": {
                      \"services\": {
                        \"objectStoreV2\": {
                          \"enabled\": true
                        }
                      }
                    }
                  },
                  \"target\": {
                    \"targetId\": \"$(CH2_TARGET)\",
                    \"provider\": \"MC\",
                    \"deploymentSettings\": {
                      \"runtimeVersion\": \"$(RUNTIME_VERSION)\"
                    },
                    \"replicas\": \"$(CH2_REPLICAS)\"
                  }
                }")
              
              HTTP_CODE=$(echo "$DEPLOY_RESPONSE" | grep "HTTP_CODE:" | cut -d':' -f2)
              
              if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "202" ]; then
                echo ""
                echo "=========================================="
                echo " ‚úÖ DEPLOYMENT SUCCESSFUL!"
                echo "=========================================="
                echo ""
                echo "üåê Check Runtime Manager:"
                echo "   https://anypoint.mulesoft.com/cloudhub"
              else
                echo ""
                echo "‚ùå DEPLOYMENT FAILED - HTTP $HTTP_CODE"
                echo "Response: $(echo "$DEPLOY_RESPONSE" | sed 's/HTTP_CODE:.*//')"
                exit 1
              fi
              
            displayName: 'Deploy to CloudHub 2.0'
            env:
              anypointClientId: $(anypointClientId)
              anypointClientSecret: $(anypointClientSecret)
              muleOrgId: $(muleOrgId)
