trigger:
  branches:
    include:
      - '*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: build.variables
  - name: MAVEN_CACHE_FOLDER
    value: $(Pipeline.Workspace)/.m2/repository
  - name: APP_NAME
    value: $(projectName)
  - name: RUNTIME_VERSION
    value: '4.9.0'
  - name: CLOUDHUB_TARGET
    value: 'cloudhub-us-east-2'
  - name: REPLICAS
    value: '1'
  - name: REPLICA_SIZE
    value: '0.1'

#####################################################
# BUILD STAGE
#####################################################
stages:
- stage: Build
  displayName: 'Build Mule Application'
  jobs:
  - job: BuildJob
    displayName: 'Maven Build'
    steps:

    - task: DownloadSecureFile@1
      name: mavenSettings
      displayName: 'Download Maven Settings'
      inputs:
        secureFile: 'settings.xml'

    - script: |
        mkdir -p ~/.m2
        cp $(mavenSettings.secureFilePath) ~/.m2/settings.xml
      displayName: 'Install Maven Settings'

    - task: JavaToolInstaller@0
      displayName: 'Setup Java 17'
      inputs:
        versionSpec: '17'
        jdkArchitectureOption: 'x64'
        jdkSourceOption: 'PreInstalled'

    - task: Cache@2
      displayName: 'Cache Maven Dependencies'
      inputs:
        key: 'maven | "$(Agent.OS)" | **/pom.xml'
        restoreKeys: |
          maven | "$(Agent.OS)"
        path: $(MAVEN_CACHE_FOLDER)

    - script: |
        mvn clean package \
          -DskipTests \
          -Dsecure.key=mule \
          -Dmule.env=dev \
          -s ~/.m2/settings.xml
      displayName: 'Maven Package'

    - task: CopyFiles@2
      displayName: 'Copy Artifacts'
      inputs:
        Contents: '**/target/*.jar'
        TargetFolder: $(Build.ArtifactStagingDirectory)
        flattenFolders: true

    - task: PublishPipelineArtifact@1
      displayName: 'Publish Artifacts'
      inputs:
        targetPath: $(Build.ArtifactStagingDirectory)
        artifact: mule-app

#####################################################
# DEPLOY STAGE â€“ CLOUDHUB 2.0
#####################################################
- stage: Deploy
  displayName: 'Deploy to CloudHub 2.0'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
    - job: DeployJob
      displayName: 'CloudHub 2.0 Deployment'
      steps:

        - task: DownloadPipelineArtifact@2
          inputs:
            artifactName: 'mule-app'
            targetPath: $(System.DefaultWorkingDirectory)/artifacts

        - task: NodeTool@0
          inputs:
            versionSpec: '18.x'

        - script: |
            npm install -g anypoint-cli@3
            anypoint-cli --version
          displayName: 'Install Anypoint CLI'

        - script: |
            set -e

            JAR_FILE=$(find $(System.DefaultWorkingDirectory)/artifacts -name "*.jar" | head -1)

            echo "Deploying $JAR_FILE"

            export ANYPOINT_CLIENT_ID="$(anypointClientId)"
            export ANYPOINT_CLIENT_SECRET="$(anypointClientSecret)"

            anypoint-cli runtime-mgr application deploy \
              "$(APP_NAME)" \
              "$(CLOUDHUB_TARGET)" \
              "$(RUNTIME_VERSION)" \
              "$JAR_FILE" \
              --client_id "$ANYPOINT_CLIENT_ID" \
              --client_secret "$ANYPOINT_CLIENT_SECRET" \
              --organization "$(muleOrgId)" \
              --environment "Sandbox" \
              --replicas $(REPLICAS) \
              --replicaSize $(VCORES) \
              --property mule.env=dev \
              --property secure.key=mule \
              --output json
          displayName: 'Deploy to CloudHub 2.0'
          env:
            anypointClientId: $(anypointClientId)
            anypointClientSecret: $(anypointClientSecret)
            muleOrgId: $(muleOrgId)
