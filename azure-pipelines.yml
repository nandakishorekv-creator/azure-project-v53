# Azure Pipelines YAML for MuleSoft Projects
# ‚úÖ FIXED: Anypoint CLI authentication with proper credential handling
# ‚úÖ Complete pipeline with Maven 3.9.10 + All features enabled

trigger:
  branches:
    include:
      - '*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: build.variables
  - name: disable.coverage.autogenerate
    value: 'true'
  - name: MAVEN_VERSION
    value: '3.9.10'
  - name: MAVEN_CACHE_FOLDER
    value: $(Pipeline.Workspace)/.m2/repository
  - name: MAVEN_HOME
    value: /opt/maven
  - name: PROJECT_NAME
    value: $[variables.projectName]
  - name: MULE_ORG
    value: $[variables.muleOrg]
  - name: MULE_ORG_ID
    value: $[variables.muleOrgId]

stages:
  #####################################################
  # BUILD STAGE
  #####################################################
  - stage: Build
    displayName: 'Build and Test Stage'
    jobs:
      - job: BuildAndTest
        displayName: 'Build and Test Job'
        steps:
          # =============================================
          # STEP 1: Download settings.xml (Secure Files)
          # =============================================
          - task: DownloadSecureFile@1
            name: mavenSettings
            displayName: 'Download Maven Settings from Secure Files'
            inputs:
              secureFile: 'settings.xml'
          
          # =============================================
          # STEP 2: Install Maven 3.9.10 (Multiple Mirrors + Retry Logic)
          # =============================================
          - script: |
              set -e
              
              echo "=================================================="
              echo "  Installing Maven $(MAVEN_VERSION)"
              echo "=================================================="
              echo ""
              
              # Show current state
              echo "üìã Pre-installed Maven:"
              mvn --version 2>/dev/null || echo "   Not found"
              echo ""
              
              MAVEN_DIR="apache-maven-$(MAVEN_VERSION)"
              MAVEN_ARCHIVE="maven.tar.gz"
              
              # ‚úÖ CRITICAL: Multiple mirror URLs with fallback
              MAVEN_MIRRORS=(
                "https://dlcdn.apache.org/maven/maven-3/$(MAVEN_VERSION)/binaries/apache-maven-$(MAVEN_VERSION)-bin.tar.gz"
                "https://archive.apache.org/dist/maven/maven-3/$(MAVEN_VERSION)/binaries/apache-maven-$(MAVEN_VERSION)-bin.tar.gz"
                "https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/$(MAVEN_VERSION)/apache-maven-$(MAVEN_VERSION)-bin.tar.gz"
                "https://mirrors.ocf.berkeley.edu/apache/maven/maven-3/$(MAVEN_VERSION)/binaries/apache-maven-$(MAVEN_VERSION)-bin.tar.gz"
              )
              
              DOWNLOAD_SUCCESS=false
              
              # Try each mirror
              for MAVEN_URL in "${MAVEN_MIRRORS[@]}"; do
                echo "üì• Trying mirror: $(echo $MAVEN_URL | sed 's|/[^/]*$||' | sed 's|https://||')"
                echo "   Full URL: $MAVEN_URL"
                
                # Try wget first
                if timeout 90 wget --progress=dot:giga --timeout=30 --tries=2 -O "$MAVEN_ARCHIVE" "$MAVEN_URL" 2>&1; then
                  echo "‚úÖ Downloaded with wget"
                  DOWNLOAD_SUCCESS=true
                  break
                else
                  echo "‚ö†Ô∏è wget failed, trying curl..."
                  rm -f "$MAVEN_ARCHIVE" 2>/dev/null || true
                  
                  # Try curl as fallback
                  if timeout 90 curl -fL --progress-bar --connect-timeout 30 --max-time 90 --retry 2 -o "$MAVEN_ARCHIVE" "$MAVEN_URL" 2>&1; then
                    echo "‚úÖ Downloaded with curl"
                    DOWNLOAD_SUCCESS=true
                    break
                  else
                    echo "‚ùå Failed to download from this mirror"
                    rm -f "$MAVEN_ARCHIVE" 2>/dev/null || true
                  fi
                fi
                
                echo ""
              done
              
              if [ "$DOWNLOAD_SUCCESS" = false ]; then
                echo "‚ùå ERROR: All mirror downloads failed"
                exit 1
              fi
              
              # Verify download
              FILE_SIZE=$(stat -c%s "$MAVEN_ARCHIVE" 2>/dev/null || stat -f%z "$MAVEN_ARCHIVE" 2>/dev/null)
              if [ "$FILE_SIZE" -lt 8000000 ]; then
                echo "‚ùå ERROR: File too small ($FILE_SIZE bytes)"
                exit 1
              fi
              
              # Extract
              echo "üì¶ Extracting Maven..."
              tar -xzf "$MAVEN_ARCHIVE"
              
              if [ ! -d "$MAVEN_DIR" ]; then
                echo "‚ùå ERROR: Directory '$MAVEN_DIR' not found after extraction"
                exit 1
              fi
              
              # Install
              echo "üì• Installing to $(MAVEN_HOME)..."
              sudo rm -rf $(MAVEN_HOME) 2>/dev/null || true
              sudo mv "$MAVEN_DIR" $(MAVEN_HOME)
              sudo chmod -R 755 $(MAVEN_HOME)
              
              # Verify installation
              if [ ! -f $(MAVEN_HOME)/bin/mvn ]; then
                echo "‚ùå ERROR: Maven binary not found"
                exit 1
              fi
              
              echo "‚úÖ Maven installed successfully"
              $(MAVEN_HOME)/bin/mvn --version
              
              rm -f "$MAVEN_ARCHIVE"
              
            displayName: 'Install Maven 3.9.10 (Multiple Mirrors)'
          
          # =============================================
          # STEP 3: Install settings.xml
          # =============================================
          - script: |
              echo "üì¶ Installing Maven settings.xml..."
              mkdir -p ~/.m2
              
              if [ ! -f "$(mavenSettings.secureFilePath)" ]; then
                echo "‚ùå ERROR: settings.xml not found"
                exit 1
              fi
              
              cp $(mavenSettings.secureFilePath) ~/.m2/settings.xml
              
              if [ -f ~/.m2/settings.xml ]; then
                echo "‚úÖ settings.xml installed"
              else
                echo "‚ùå ERROR: Installation failed"
                exit 1
              fi
              
            displayName: 'Install and Validate Maven Settings'

          # =============================================
          # STEP 4: Setup Java 17
          # =============================================
          - task: JavaToolInstaller@0
            displayName: 'Install Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          # =============================================
          # STEP 5: Verify Environment
          # =============================================
          - script: |
              echo "=================================================="
              echo "  Build Environment"
              echo "=================================================="
              
              echo "‚òï Java:"
              java -version 2>&1 | head -3
              
              echo "üì¶ Maven:"
              export M2_HOME=$(MAVEN_HOME)
              export PATH=$(MAVEN_HOME)/bin:$PATH
              mvn --version
              
              echo "‚öôÔ∏è Settings:"
              if [ -f ~/.m2/settings.xml ]; then
                echo "   ‚úÖ settings.xml exists"
              else
                echo "   ‚ùå settings.xml missing"
                exit 1
              fi
              
              echo "üìã POM:"
              if [ -f pom.xml ]; then
                echo "   ‚úÖ pom.xml found"
              else
                echo "   ‚ö†Ô∏è pom.xml not found"
              fi
              
            displayName: 'Verify Build Environment'
            env:
              M2_HOME: $(MAVEN_HOME)

          # =============================================
          # STEP 6: Cache Maven Dependencies
          # =============================================
          - task: Cache@2
            displayName: 'Cache Maven Dependencies'
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
                maven
              path: $(MAVEN_CACHE_FOLDER)

          # =============================================
          # STEP 7: Install Anypoint CLI
          # =============================================
          - script: |
              echo "=================================================="
              echo "  Installing Anypoint CLI"
              echo "=================================================="
              
              npm install -g anypoint-cli@latest
              
              if [ $? -eq 0 ]; then
                echo "‚úÖ Anypoint CLI installed successfully"
                anypoint-cli --version
              else
                echo "‚ùå ERROR: Failed to install Anypoint CLI"
                exit 1
              fi
              
            displayName: 'Install Anypoint CLI'

          # =============================================
          # STEP 9: Maven Validate
          # =============================================
          - script: |
              export M2_HOME=$(MAVEN_HOME)
              export PATH=$(MAVEN_HOME)/bin:$PATH
              
              echo "üîç Running Maven validate..."
              
              mvn validate \
                -Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) \
                -s ~/.m2/settings.xml \
                -e
              
              if [ $? -ne 0 ]; then
                echo "‚ùå VALIDATION FAILED"
                exit 1
              fi
              
              echo "‚úÖ Validation completed successfully"
              
            displayName: 'Maven Validate'
            env:
              M2_HOME: $(MAVEN_HOME)

          # =============================================
          # STEP 10: Maven Package
          # =============================================
          - script: |
              export M2_HOME=$(MAVEN_HOME)
              export PATH=$(MAVEN_HOME)/bin:$PATH
              
              echo "üì¶ Running Maven package..."
              
              mvn clean package \
                -Dmule.version=4.9.0 \
                -Dsecure.key=mule \
                -Dmule.env=dev \
                -DskipTests \
                -s ~/.m2/settings.xml \
                -e
              
              if [ $? -ne 0 ]; then
                echo "‚ùå PACKAGE BUILD FAILED"
                exit 1
              fi
              
              echo "‚úÖ Package completed successfully"
              
              # Verify JAR was created
              if [ -d target ]; then
                JAR_FILE=$(ls -1 target/*.jar 2>/dev/null | head -1)
                if [ -n "$JAR_FILE" ]; then
                  echo "‚úÖ JAR file created:"
                  ls -lh target/*.jar
                else
                  echo "‚ùå ERROR: No JAR file found in target/"
                  exit 1
                fi
              else
                echo "‚ùå ERROR: target/ directory not found"
                exit 1
              fi
              
            displayName: 'Maven Package'
            env:
              M2_HOME: $(MAVEN_HOME)

          # =============================================
          # STEP 11: Copy Build Artifacts
          # =============================================
          - task: CopyFiles@2
            displayName: 'Copy Build Artifacts'
            inputs:
              Contents: |
                **/target/*.jar
                pom.xml
              TargetFolder: $(Build.ArtifactStagingDirectory)
              flattenFolders: false

          # =============================================
          # STEP 12: Publish Pipeline Artifacts
          # =============================================
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Pipeline Artifacts'
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)
              artifact: 'drop'

  #####################################################
  # DEPLOY STAGE: CloudHub Deployment
  #####################################################
  - stage: Deploy
    displayName: 'Deploy to CloudHub'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: DeployToCloudHub
        displayName: 'Deploy to CloudHub Sandbox'
        steps:
          # =============================================
          # STEP 1: Checkout Code (Required for Rebuild)
          # =============================================
          - checkout: self
            displayName: 'Checkout Source Code'
            clean: true
          
          # =============================================
          # STEP 2: Download settings.xml
          # =============================================
          - task: DownloadSecureFile@1
            name: mavenSettingsDeploy
            displayName: 'Download Maven Settings'
            inputs:
              secureFile: 'settings.xml'
          
          - script: |
              echo "üì¶ Installing settings.xml for deployment..."
              mkdir -p ~/.m2
              cp $(mavenSettingsDeploy.secureFilePath) ~/.m2/settings.xml
              
              if [ -f ~/.m2/settings.xml ]; then
                echo "‚úÖ settings.xml installed"
              else
                echo "‚ùå ERROR: settings.xml not found"
                exit 1
              fi
              
            displayName: 'Install Maven Settings for Deploy'
          
          # =============================================
          # STEP 3: Setup Java 17
          # =============================================
          - task: JavaToolInstaller@0
            displayName: 'Install Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          
          # =============================================
          # STEP 4: Install Maven 3.9.10
          # =============================================
          - script: |
              set -e
              
              echo "üîß Installing Maven $(MAVEN_VERSION) for deployment..."
              
              MAVEN_MIRRORS=(
                "https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/$(MAVEN_VERSION)/apache-maven-$(MAVEN_VERSION)-bin.tar.gz"
                "https://archive.apache.org/dist/maven/maven-3/$(MAVEN_VERSION)/binaries/apache-maven-$(MAVEN_VERSION)-bin.tar.gz"
              )
              
              MAVEN_ARCHIVE="maven.tar.gz"
              DOWNLOAD_SUCCESS=false
              
              for MAVEN_URL in "${MAVEN_MIRRORS[@]}"; do
                echo "üì• Trying: $MAVEN_URL"
                
                if timeout 90 wget --progress=dot:giga --timeout=30 --tries=2 -O "$MAVEN_ARCHIVE" "$MAVEN_URL" || \
                   timeout 90 curl -fL --connect-timeout 30 --max-time 90 --retry 2 -o "$MAVEN_ARCHIVE" "$MAVEN_URL"; then
                  echo "‚úÖ Download successful"
                  DOWNLOAD_SUCCESS=true
                  break
                fi
                rm -f "$MAVEN_ARCHIVE" 2>/dev/null || true
              done
              
              if [ "$DOWNLOAD_SUCCESS" = false ]; then
                echo "‚ùå All download mirrors failed"
                exit 1
              fi
              
              tar -xzf "$MAVEN_ARCHIVE"
              sudo rm -rf $(MAVEN_HOME) 2>/dev/null || true
              sudo mv apache-maven-$(MAVEN_VERSION) $(MAVEN_HOME)
              sudo chmod -R 755 $(MAVEN_HOME)
              
              echo "‚úÖ Maven installed:"
              $(MAVEN_HOME)/bin/mvn --version
              
              rm -f "$MAVEN_ARCHIVE"
              
            displayName: 'Install Maven 3.9.10'
          
          # =============================================
          # STEP 5: Cache Maven Dependencies
          # =============================================
          - task: Cache@2
            displayName: 'Cache Maven Dependencies'
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
                maven
              path: $(MAVEN_CACHE_FOLDER)
          
          # =============================================
          # STEP 6: Build and Deploy to CloudHub
          # =============================================
          - script: |
              export M2_HOME=$(MAVEN_HOME)
              export PATH=$(MAVEN_HOME)/bin:$PATH
              
              # Export credentials for dependency resolution if needed
              export anypointClientId=$(anypointClientId)
              export anypointClientSecret=$(anypointClientSecret)
              
              echo "=================================================="
              echo " CloudHub Deployment"
              echo "=================================================="
              echo "Runtime: 4.9.0"
              echo "Application: azure-project-v53"
              echo "Environment: Sandbox"
              echo ""
              
              # Verify environment
              echo "‚òï Java:"
              java -version 2>&1 | head -1
              echo ""
              echo "üì¶ Maven:"
              mvn --version | head -1
              echo ""
              
              # Verify POM exists
              if [ ! -f pom.xml ]; then
                echo "‚ùå ERROR: pom.xml not found in root directory"
                exit 1
              fi
              
              echo "‚úÖ Project files verified"
              echo ""
              echo "üì¶ Building and deploying..."
              echo ""
              
              # ‚úÖ Package + Deploy in one command from Source Root
              mvn clean package mule:deploy \
                -Pcloudhub2 \
                -Dmule.version=4.9.0 \
                -Danypoint.bearerToken=$(ANYPOINT_BEARER_TOKEN) \
                -Dmule.env=dev \
                -Dsecure.key=mule \
                -DskipTests \
                -Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) \
                -s ~/.m2/settings.xml \
                -e
                
              if [ $? -eq 0 ]; then
                echo ""
                echo "=================================================="
                echo " ‚úÖ DEPLOYMENT SUCCESSFUL!"
                echo "=================================================="
                echo ""
                echo "Application: azure-project-v53"
                echo "Environment: Sandbox"
                echo "Region: us-east-2"
                echo ""
                echo "üåê Check status at:"
                echo "   https://anypoint.mulesoft.com/cloudhub"
              else
                echo ""
                echo "‚ùå DEPLOYMENT FAILED"
                exit 1
              fi
              
            displayName: 'Build and Deploy to CloudHub'
            env:
              M2_HOME: $(MAVEN_HOME)
              ANYPOINT_BEARER_TOKEN: $(ANYPOINT_BEARER_TOKEN)
              anypointClientId: $(anypointClientId)
              anypointClientSecret: $(anypointClientSecret)
