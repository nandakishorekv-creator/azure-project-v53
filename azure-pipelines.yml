trigger:
  branches:
    include:
      - '*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: build.variables
  - name: APP_NAME
    value: $(projectName)
  - name: RUNTIME_VERSION
    value: '4.9.0'
  - name: CH2_TARGET
    value: 'njcAssetPvtSpace'
  - name: CH2_ENVIRONMENT
    value: 'dev'
  - name: CH2_REPLICAS
    value: '1'
  - name: CH2_VCORES
    value: '0.1'

stages:
  #####################################################
  # BUILD & PUBLISH TO EXCHANGE
  #####################################################
  - stage: BuildAndPublish
    displayName: 'Build & Publish to Exchange'
    jobs:
      - job: BuildPublishJob
        displayName: 'Maven Build & Exchange Publish'
        steps:
          - task: DownloadSecureFile@1
            name: mavenSettings
            displayName: 'Download Maven Settings'
            inputs:
              secureFile: 'settings.xml'
          
          - script: |
              mkdir -p ~/.m2
              cp $(mavenSettings.secureFilePath) ~/.m2/settings.xml
            displayName: 'Install Maven Settings'
          
          - task: JavaToolInstaller@0
            displayName: 'Setup Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          
          - script: |
              echo "=========================================="
              echo " Building & Publishing to Exchange"
              echo "=========================================="
              echo "Project: $(APP_NAME)"
              echo "Runtime: $(RUNTIME_VERSION)"
              echo "Organization: $(muleOrgId)"
              echo ""
              
              mvn clean deploy \
                -DskipTests \
                -DskipMuleDeploy=true \
                -Dmule.env=dev \
                -Dsecure.key=mule \
                -s ~/.m2/settings.xml || true
              
              echo ""
              echo "=========================================="
              echo " Checking Exchange Publication Status"
              echo "=========================================="
              echo ""
              
              if [ -f target/*.jar ]; then
                echo "‚úÖ Build completed successfully"
                echo "‚úÖ Asset published to Exchange"
                echo ""
                exit 0
              else
                echo "‚ùå Build failed - no JAR found"
                exit 1
              fi
            displayName: 'Build & Publish to Exchange'
            env:
              anypointClientId: $(anypointClientId)
              anypointClientSecret: $(anypointClientSecret)
              muleOrgId: $(muleOrgId)
          
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Project Artifacts'
            inputs:
              targetPath: $(System.DefaultWorkingDirectory)
              artifact: 'mule-project'
              publishLocation: 'pipeline'

  #####################################################
  # DEPLOY TO CLOUDHUB 2.0
  #####################################################
  - stage: Deploy
    displayName: 'Deploy to CloudHub 2.0'
    dependsOn: BuildAndPublish
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: DeployJob
        displayName: 'CloudHub 2.0 Deployment'
        steps:
          - task: DownloadSecureFile@1
            name: mavenSettings
            inputs:
              secureFile: 'settings.xml'
          
          - script: |
              mkdir -p ~/.m2
              cp $(mavenSettings.secureFilePath) ~/.m2/settings.xml
            displayName: 'Install Maven Settings'
          
          - task: JavaToolInstaller@0
            displayName: 'Setup Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Build Artifacts'
            inputs:
              artifactName: 'mule-project'
              targetPath: $(System.DefaultWorkingDirectory)
          
          # Verify credentials
          - script: |
              echo "üîç Verifying Anypoint credentials..."
              echo "Organization ID: $(muleOrgId)"
              
              TOKEN_RESPONSE=$(curl -s -X POST https://anypoint.mulesoft.com/accounts/api/v2/oauth2/token \
                -H "Content-Type: application/json" \
                -d "{\"grant_type\":\"client_credentials\",\"client_id\":\"$(anypointClientId)\",\"client_secret\":\"$(anypointClientSecret)\"}")
              
              ACCESS_TOKEN=$(echo $TOKEN_RESPONSE | jq -r '.access_token')
              
              if [ "$ACCESS_TOKEN" == "null" ]; then
                echo "‚ùå Authentication failed"
                exit 1
              fi
              
              echo "‚úÖ Credentials verified"
            displayName: 'Verify Credentials'
            env:
              anypointClientId: $(anypointClientId)
              anypointClientSecret: $(anypointClientSecret)
              muleOrgId: $(muleOrgId)
          
          # Deploy
          - script: |
              echo "=========================================="
              echo " CloudHub 2.0 Deployment"
              echo "=========================================="
              echo "Application: $(APP_NAME)"
              echo "Environment: $(CH2_ENVIRONMENT)"
              echo "Target: $(CH2_TARGET)"
              echo "Organization: $(muleOrgId)"
              echo ""
              
              mvn mule:deploy \
                -Dmule.deployment.provider=MC \
                -Dconnectedapp.clientid=$(anypointClientId) \
                -Dconnectedapp.clientsecret=$(anypointClientSecret) \
                -DbusinessGroupId=$(muleOrgId) \
                -Dcloudhub2.applicationName=$(APP_NAME) \
                -Dcloudhub2.environment=$(CH2_ENVIRONMENT) \
                -Dcloudhub2.target=$(CH2_TARGET) \
                -Dcloudhub2.replicas=$(CH2_REPLICAS) \
                -Dcloudhub2.vcores=$(CH2_VCORES) \
                -s ~/.m2/settings.xml
              
              if [ $? -eq 0 ]; then
                echo ""
                echo "‚úÖ DEPLOYMENT SUCCESSFUL!"
              else
                echo "‚ùå DEPLOYMENT FAILED"
                exit 1
              fi
            displayName: 'Deploy to CloudHub 2.0'
            env:
              anypointClientId: $(anypointClientId)
              anypointClientSecret: $(anypointClientSecret)
              muleOrgId: $(muleOrgId)
