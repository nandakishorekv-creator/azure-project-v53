trigger:
  branches:
    include:
      - '*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: build.variables
  - name: APP_NAME
    value: $(projectName)
  - name: RUNTIME_VERSION
    value: '4.9.0'
  - name: CH2_TARGET
    value: 'Cloudhub-US-East-2'
  - name: CH2_ENVIRONMENT
    value: 'Sandbox'
  - name: CH2_REPLICAS
    value: '1'
  - name: CH2_VCORES
    value: '0.1'

stages:
  #####################################################
  # BUILD STAGE
  #####################################################
  - stage: Build
    displayName: 'Build Mule Application'
    jobs:
      - job: BuildJob
        displayName: 'Maven Build'
        steps:
          - task: DownloadSecureFile@1
            name: mavenSettings
            displayName: 'Download Maven Settings'
            inputs:
              secureFile: 'settings.xml'
          
          - script: |
              mkdir -p ~/.m2
              cp $(mavenSettings.secureFilePath) ~/.m2/settings.xml
            displayName: 'Install Maven Settings'
          
          - task: JavaToolInstaller@0
            displayName: 'Setup Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          
          - script: |
              echo "Building: $(APP_NAME)"
              mvn clean package -DskipTests -s ~/.m2/settings.xml
              
              if [ $? -eq 0 ]; then
                echo "‚úÖ BUILD SUCCESSFUL"
                ls -lh target/*.jar
              else
                echo "‚ùå BUILD FAILED"
                exit 1
              fi
            displayName: 'Maven Package'
          
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Build Artifacts'
            inputs:
              targetPath: target
              artifact: 'mule-app'
              publishLocation: 'pipeline'

  #####################################################
  # DEPLOY STAGE WITH FULL DEBUG
  #####################################################
  - stage: Deploy
    displayName: 'Deploy to CloudHub 2.0 (Debug Mode)'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: DeployJob
        displayName: 'CloudHub 2.0 Deployment'
        steps:
          - task: DownloadSecureFile@1
            name: mavenSettings
            inputs:
              secureFile: 'settings.xml'
          
          - script: |
              mkdir -p ~/.m2
              cp $(mavenSettings.secureFilePath) ~/.m2/settings.xml
            displayName: 'Install Maven Settings'
          
          - task: JavaToolInstaller@0
            displayName: 'Setup Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Build Artifacts'
            inputs:
              artifactName: 'mule-app'
              targetPath: $(System.DefaultWorkingDirectory)/target
          
          # Pre-deployment diagnostics
          - script: |
              echo "=========================================="
              echo " PRE-DEPLOYMENT DIAGNOSTICS"
              echo "=========================================="
              echo ""
              echo "üìã Configuration:"
              echo "   App Name: $(APP_NAME)"
              echo "   Environment: $(CH2_ENVIRONMENT)"
              echo "   Target: $(CH2_TARGET)"
              echo "   Runtime: $(RUNTIME_VERSION)"
              echo "   Org ID: $(muleOrgId)"
              echo ""
              
              echo "üì¶ JAR File Check:"
              JAR_FILE=$(find target -name "*.jar" -type f | head -1)
              if [ -z "$JAR_FILE" ]; then
                echo "   ‚ùå JAR file not found!"
                exit 1
              else
                echo "   ‚úÖ Found: $JAR_FILE"
                echo "   Size: $(du -h "$JAR_FILE" | cut -f1)"
                echo "   MD5: $(md5sum "$JAR_FILE" | cut -d' ' -f1)"
              fi
              echo ""
              
              echo "üîê Credentials Check:"
              if [ -z "$(anypointClientId)" ]; then
                echo "   ‚ùå Client ID is missing!"
                exit 1
              else
                echo "   ‚úÖ Client ID: $(anypointClientId)"
              fi
              
              if [ -z "$(anypointClientSecret)" ]; then
                echo "   ‚ùå Client Secret is missing!"
                exit 1
              else
                echo "   ‚úÖ Client Secret: [REDACTED] (length: ${#ANYPOINT_SECRET})"
              fi
              
              if [ -z "$(muleOrgId)" ]; then
                echo "   ‚ùå Org ID is missing!"
                exit 1
              else
                echo "   ‚úÖ Org ID: $(muleOrgId)"
              fi
              echo ""
              
              echo "üìÅ POM Configuration:"
              if [ -f "pom.xml" ]; then
                echo "   ‚úÖ pom.xml exists"
                echo "   GroupId: $(grep -m1 '<groupId>' pom.xml | sed 's/.*<groupId>\(.*\)<\/groupId>.*/\1/')"
                echo "   ArtifactId: $(grep -m1 '<artifactId>' pom.xml | sed 's/.*<artifactId>\(.*\)<\/artifactId>.*/\1/')"
                echo "   Version: $(grep -m1 '<version>' pom.xml | sed 's/.*<version>\(.*\)<\/version>.*/\1/')"
              else
                echo "   ‚ùå pom.xml not found!"
              fi
              echo ""
              
            displayName: 'Pre-Deployment Diagnostics'
            env:
              ANYPOINT_SECRET: $(anypointClientSecret)
          
          # Deploy with full debug logging
          - script: |
              echo "=========================================="
              echo " CLOUDHUB 2.0 DEPLOYMENT (DEBUG MODE)"
              echo "=========================================="
              echo ""
              echo "üöÄ Starting deployment with full debug logging..."
              echo "   (This will show detailed error information)"
              echo ""
              
              # Deploy with -X (debug) and -e (error traces)
              mvn mule:deploy \
                -X \
                -e \
                -DskipTests \
                -Dmaven.deploy.skip=true \
                -Dmule.deployment.provider=MC \
                -Dconnectedapp.clientid=$(anypointClientId) \
                -Dconnectedapp.clientsecret=$(anypointClientSecret) \
                -Danypoint.orgid=$(muleOrgId) \
                -Dcloudhub2.applicationName=$(APP_NAME) \
                -Dcloudhub2.environment=$(CH2_ENVIRONMENT) \
                -Dcloudhub2.target=$(CH2_TARGET) \
                -Dcloudhub2.replicas=$(CH2_REPLICAS) \
                -Dcloudhub2.vcores=$(CH2_VCORES) \
                -Dmule.env=dev \
                -Dsecure.key=mule \
                -s ~/.m2/settings.xml
              
              EXIT_CODE=$?
              
              echo ""
              echo "=========================================="
              if [ $EXIT_CODE -eq 0 ]; then
                echo " ‚úÖ DEPLOYMENT SUCCESSFUL!"
                echo "=========================================="
                echo ""
                echo "üåê Check Runtime Manager:"
                echo "   https://anypoint.mulesoft.com/cloudhub"
              else
                echo " ‚ùå DEPLOYMENT FAILED"
                echo "=========================================="
                echo ""
                echo "Exit Code: $EXIT_CODE"
                echo ""
                echo "üîç Check the logs above for detailed error information."
                echo "   Look for lines starting with 'ERROR' or 'Caused by:'"
                echo ""
                echo "Common Issues:"
                echo "   1. Environment '$(CH2_ENVIRONMENT)' doesn't exist"
                echo "   2. Target '$(CH2_TARGET)' not found"
                echo "   3. Invalid Connected App permissions"
                echo "   4. Application name already exists"
                echo "   5. Insufficient vCore allocation"
                echo ""
              fi
              
              exit $EXIT_CODE
              
            displayName: 'Deploy to CloudHub 2.0 (Debug)'
            env:
              anypointClientId: $(anypointClientId)
              anypointClientSecret: $(anypointClientSecret)
              muleOrg: $(muleOrg)
              muleOrgId: $(muleOrgId)
